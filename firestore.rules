
rules_version = '2';

service cloud.firestore {

  match /databases/{database}/documents {
    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the requesting user's UID matches the provided userId.
     * Used to enforce ownership of a document or data path.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isLeadOwner(leadId) {
      let leadData = get(/databases/$(database)/documents/leads/$(leadId)).data;
      return isOwner(leadData.ownerId);
    }

    /**
     * Checks for ownership on an existing document.
     * CRITICAL: Prevents updates/deletes on non-existent documents.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Gets the role of the currently authenticated user from their staff profile.
     * The user's staff profile document ID is expected to be their Firebase Auth UID.
     */
    function getUserRole() {
      let path = /databases/$(database)/documents/staff/$(request.auth.uid);
      if (exists(path)) {
        return get(path).data.role;
      }
      return null;
    }

    /**
     * Checks if the currently authenticated user has the 'Admin' role.
     */
    function isAdmin() {
      return isSignedIn() && getUserRole() == 'Admin';
    }


    // ----------------------------------------------------------------------
    // Application Rules (Authenticated Routes)
    // ----------------------------------------------------------------------
      
    /**
      * @description Controls access to the single KPI document.
      */
    match /kpis/{docId} {
      allow get: if isSignedIn();
      allow write: if isAdmin();
    }
    
    match /articles/{articleId} {
        allow get, list: if isSignedIn();
        allow create, update, delete: if isAdmin();
    }

    /**
      * @description Controls access to sales leads.
      * A 'list' operation (query) is implicitly allowed if the query's constraints
      * guarantee that every potential document returned would be allowed by the 'get' rule.
      */
    match /leads/{leadId} {
      // Explicitly allow Admins and Supervisors to perform list queries.
      // The client-side code applies the necessary filters for Supervisors.
      // Brokers' list queries are constrained by ownerId and secured by the 'get' rule.
      allow list: if isAdmin() || getUserRole() == 'Supervisor';
      allow get: if isOwner(resource.data.ownerId) || isAdmin() || getUserRole() == 'Supervisor';
      allow create: if isOwner(request.resource.data.ownerId) || isAdmin();
      allow update: if isOwner(resource.data.ownerId) || isAdmin();
      allow delete: if isOwner(resource.data.ownerId) || isAdmin();

        /**
        * @description Controls access to a lead's note history.
        */
        match /noteHistory/{noteId} {
          allow list, get: if isSignedIn();
          allow create: if isOwner(get(/databases/$(database)/documents/leads/$(leadId)).data.ownerId) || isAdmin();
          allow update: if false;
          allow delete: if false;
        }
    }

    /**
      * @description Controls access to staff member data.
      */
    match /staff/{staffId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }
    
    match /dealerships/{dealershipId} {
        allow get, list: if isSignedIn();
        allow create, update, delete: if isAdmin();
    }

    match /notifications/{notificationId} {
      allow get, update, delete: if isOwner(resource.data.userId);
      allow create: if isSignedIn();
      // List is implicitly allowed if the query constrains by userId, which is handled by the client.
      // The 'get' rule above will secure the query.
      allow list: if request.query.where.userId == request.auth.uid;
    }

    match /todos/{todoId} {
      allow get, update, delete: if isOwner(resource.data.userId);
      allow create: if isOwner(request.resource.data.userId);
      // List is implicitly allowed if the query constrains by userId.
      // The 'get' rule above will secure the query.
      allow list: if request.query.where.userId == request.auth.uid;
    }
    
    match /appointments/{appointmentId} {
      allow get, list: if isSignedIn();
      allow create: if isOwner(request.resource.data.ownerId);
      allow update, delete: if isOwner(resource.data.ownerId) || isAdmin();
    }

    match /contracts/{contractId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    match /signatures/{signatureId} {
      allow get: if isSignedIn();
      allow list: if isAdmin();
      // Users can only create signatures for themselves.
      allow create: if isOwner(request.resource.data.userId);
      // Signatures are immutable.
      allow update, delete: if false;
    }

    match /contract_events/{eventId} {
      allow get, list: if isAdmin();
      allow create: if isAdmin();
      allow update, delete: if false;
    }

    // Public can create an application, but not read/update/delete.
    // Admins can manage candidates.
    match /candidates/{candidateId} {
      // Allow public creation only if server-side flow ran successfully (indicated by score presence)
      allow create: if request.resource.data.score is number;

      // Only admins can read, update, or delete candidate data once created.
      allow read, update, delete: if isAdmin();
      allow list: if isAdmin();
    }

    match /inventory/{vehicleId} {
      allow read: if isSignedIn();
      allow create, update, delete: if isAdmin() || getUserRole() == 'Supervisor';
    }

    // LMS Rules
    match /courses/{courseId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin() || getUserRole() == 'Supervisor';
    }
    match /modules/{moduleId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin() || getUserRole() == 'Supervisor';
    }
    match /lessons/{lessonId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin() || getUserRole() == 'Supervisor';
    }
    match /quizzes/{quizId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin() || getUserRole() == 'Supervisor';
    }
    match /userProgress/{progressId} {
      allow read: if isOwner(resource.data.userId) || isAdmin() || getUserRole() == 'Supervisor';
      allow create, update: if isOwner(request.resource.data.userId);
      allow delete: if false;
    }
    match /certificates/{certId} {
      // Anyone can view a specific certificate to verify it
      allow get: if true;
      // Users can list their own certificates, admins/supervisors can list any
      allow list: if (isSignedIn() && request.query.userId == request.auth.uid) || isAdmin() || getUserRole() == 'Supervisor';
      // A user can create their own certificate record upon completing a course
      allow create: if isOwner(request.resource.data.userId);
      // Only Admins can modify or delete certificates
      allow update, delete: if isAdmin();
    }
  }
}

    